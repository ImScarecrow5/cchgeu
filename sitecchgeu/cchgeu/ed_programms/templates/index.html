{% extends "template.html" %}
{% load static %}
{% block title %}–û–±—Ä. –ü—Ä–æ–≥—Ä–∞–º–º–∞{% endblock title %}
{% block main %}
	<div class="main-content">
		<div class="sidebar-menu">
		<ul>
			<li class="active"><a href="#">–û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã</a></li>
			<li><a href="#">–û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—ã</a></li>
			<li><a href="#">–§–µ–¥–µ—Ä–∞–ª—å–Ω—ã–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è</a></li>
			<li><a href="#">–£—á–µ–±–Ω—ã–µ –ø–ª–∞–Ω—ã</a></li>
			<li><a href="#">–ö–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã–µ —É—á–µ–±–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏</a></li>
			<li><a href="#">–ú–µ—Ç–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ</a></li>
			<li><a href="#">–õ–∏—Ü–µ–Ω–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º</a></li>
		</ul>
	</div>
    <div class="programs-container">
	<div style="display: flex; align-items: center; margin-bottom: 20px;">
    <h1>–û–ë–†–ê–ó–û–í–ê–¢–ï–õ–¨–ù–´–ï –ü–†–û–ì–†–ê–ú–ú–´</h1>
    <div class="search-container">
    <div class="search-box">
        <input
            type="text"
            placeholder="–ü–æ–∏—Å–∫ –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–µ"
            id="searchPrograms"
            oninput="filterPrograms()"
        />
        <button onclick="filterPrograms()">
            <img src="{% static "images/search.svg" %}" alt="–ü–æ–∏—Å–∫">
        </button>
    </div>
</div>

</div>
	<!-- –ë–ª–æ–∫ "–£—Ä–æ–≤–µ–Ω—å –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è" -->
	<div class="filter-row">
		<span class="filter-label">–£—Ä–æ–≤–µ–Ω—å –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è</span>
		<div class="checkbox-group" id="group1">
			<label class="checkbox-item">
				<input type="checkbox" value="–ë–∞–∫–∞–ª–∞–≤—Ä–∏–∞—Ç" onchange="handleLevelFilterChange()">
				–ë–∞–∫–∞–ª–∞–≤—Ä–∏–∞—Ç
			</label>
			<label class="checkbox-item">
				<input type="checkbox" value="–°–ø–µ—Ü–∏–∞–ª–∏—Ç–µ—Ç" onchange="handleLevelFilterChange()">
				–°–ø–µ—Ü–∏–∞–ª–∏—Ç–µ—Ç
			</label>
			<label class="checkbox-item">
				<input type="checkbox" value="–°–ü–û" onchange="handleLevelFilterChange()">
				–°–ü–û
			</label>
			<label class="checkbox-item">
				<input type="checkbox" value="–ê—Å–ø–∏—Ä–∞–Ω—Ç—É—Ä–∞" onchange="handleLevelFilterChange()">
				–ê—Å–ø–∏—Ä–∞–Ω—Ç—É—Ä–∞
			</label>
			<label class="checkbox-item">
				<input type="checkbox" value="–ú–∞–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä–∞" onchange="handleLevelFilterChange()">
				–ú–∞–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä–∞
			</label>
		</div>
		<div class="settings-icon" onclick="toggleGroup('group1')">
			<img src="{% static 'images/faculty_filter.svg' %}">
		</div>
	</div>

	<form id="facultyForm" method="POST" style="display: none;">
    	{% csrf_token %}
    	<input type="hidden" name="selected_faculty" id="selectedFacultyInput">
	</form>

	<!-- –ë–ª–æ–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∞ –∏ —Ç–∞–±–ª–∏—Ü—ã -->
	<div class="faculty-select-container">
		<label for="faculty-select">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç</label>
		<div class="custom-select">
			<select id="faculty-select" onchange="handleFacultyChange()">
				<option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç</option>
				{% for f in faculties %}
				<option value="{{ f }}">{{ f }}</option>
				{% endfor %}
			</select>
		</div>

		<!-- –í index.html -->

    <table class="specialty-table">
		<thead>
			<tr class="sort">
				<th width="15%" data-sort="code" data-sort-type="text">
					–ö–æ–¥ <span class="sort-arrow">‚Üï</span>
				</th>
				<th width="55%" data-sort="name" data-sort-type="text">
					–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã <span class="sort-arrow">‚Üï</span>
				</th>
				<th width="30%" data-sort="level" data-sort-type="text">
					–£—Ä–æ–≤–µ–Ω—å –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è <span class="sort-arrow">‚Üï</span>
				</th>
        	</tr>
		</thead>
		<tbody id="programsTableBody">
			{% if programs %}
				{% for program in programs %}
				<tr>
					<td>{{ program.code|default:"-" }}</td>
					<td>{{ program.program|default:"-" }}</td>
					<td>{{ program.level|default:"-" }}</td>
				</tr>
				{% endfor %}
			{% else %}
				<tr>
					<td colspan="3" style="text-align: center; padding: 20px;">
						{% if selected_faculty %}
							–î–ª—è —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∞ "{{ selected_faculty }}" –ø—Ä–æ–≥—Ä–∞–º–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
						{% else %}
							–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º
						{% endif %}
					</td>
				</tr>
			{% endif %}
		</tbody>
	</table>

	<script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentPrograms = [];
        let currentFaculty = '';
        let currentSort = {
            column: null,
            direction: 'asc'
        };

        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –≥—Ä—É–ø–ø—ã —á–µ–∫–±–æ–∫—Å–æ–≤
        function toggleGroup(groupId) {
            const group = document.getElementById(groupId);
            group.classList.toggle('visible');
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
        function getSelectedLevels() {
            const checkboxes = document.querySelectorAll('#group1 input[type="checkbox"]:checked');
            const selectedLevels = [];
            checkboxes.forEach(checkbox => {
                selectedLevels.push(checkbox.value);
            });
            return selectedLevels;
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ —É—Ä–æ–≤–Ω—è–º
        function handleLevelFilterChange() {
            if (currentFaculty) {
                loadFacultyPrograms(currentFaculty);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∞
        function handleFacultyChange() {
            const select = document.getElementById('faculty-select');
            currentFaculty = select.value;

            if (!currentFaculty) {
                resetTable();
                return;
            }

            loadFacultyPrograms(currentFaculty);
        }

        // –°–±—Ä–æ—Å —Ç–∞–±–ª–∏—Ü—ã
        function resetTable() {
            const tableBody = document.getElementById('programsTableBody');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="3" style="text-align: center; padding: 20px;">
                        –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º
                    </td>
                </tr>
            `;
        }

        // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥—Ä–∞–º–º
        function loadFacultyPrograms(faculty) {
            const tableBody = document.getElementById('programsTableBody');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="3" style="text-align: center; padding: 20px;">
                        <div class="loading-spinner"></div>
                        –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º –¥–ª—è "${faculty}"...
                    </td>
                </tr>
            `;

            // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —É—Ä–æ–≤–Ω–∏
            const selectedLevels = getSelectedLevels();

            // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
            let url = `{% url 'get_faculty_programs' %}?faculty=${encodeURIComponent(faculty)}`;

            // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —É—Ä–æ–≤–Ω–µ–π
            selectedLevels.forEach(level => {
                url += `&levels=${encodeURIComponent(level)}`;
            });

            console.log('Fetch URL:', url);

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', data);
                    if (data.success) {
                        currentPrograms = data.programs;
                        updateProgramsTable(data.programs, faculty, data.count);
                    } else {
                        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ–≥—Ä–∞–º–º: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞.');
                });
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
        function updateProgramsTable(programs, facultyName, count) {
            const tableBody = document.getElementById('programsTableBody');

            if (!programs || programs.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 18px; margin-bottom: 10px;">ü§∑‚Äç‚ôÇÔ∏è</div>
                            <div>–î–ª—è —Ñ–∞–∫—É–ª—å—Ç–µ—Ç–∞ <strong>"${facultyName}"</strong> –ø—Ä–æ–≥—Ä–∞–º–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
                            <div style="font-size: 12px; margin-top: 10px;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π —Ñ–∞–∫—É–ª—å—Ç–µ—Ç –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</div>
                        </td>
                    </tr>
                `;
                return;
            }

            // –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
            tableBody.innerHTML = '';

            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º
            const countRow = document.createElement('tr');
            countRow.innerHTML = `
                <td colspan="3" style="background-color: #f5f5f5; font-weight: bold; text-align: center;">
                    –ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–≥—Ä–∞–º–º: ${count}
                </td>
            `;
            tableBody.appendChild(countRow);

            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –ø—Ä–æ–≥—Ä–∞–º–º–∞–º–∏
            programs.forEach(program => {
                const row = document.createElement('tr');
                let extractedCode = '-';
                let cleanName = program.name || '-';
                let originalName = program.original_name || program.name || '';

                if (program.name) {
                    // –ò—â–µ–º –∫–æ–¥ –∏ —É–¥–∞–ª—è–µ–º –µ–≥–æ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è
                    const match = program.name.match(/^(\d{2}\.\d{2}\.\d{2})\s*(.*)/);
                    if (match) {
                        extractedCode = match[1];
                        cleanName = match[2].trim();
                    }
                }

                row.innerHTML = `
                    <td data-sort-value="${extractedCode}">${extractedCode}</td>
                    <td data-sort-value="${cleanName}" data-original-name="${originalName}">${cleanName}</td>
                    <td data-sort-value="${program.level || ''}">${program.level || '-'}</td>
                `;
                tableBody.appendChild(row);
            });

            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–∫—É—â—É—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
            if (currentSort.column) {
                sortTable(currentSort.column, currentSort.direction);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—à–∏–±–∫–∏
        function showError(message) {
            const tableBody = document.getElementById('programsTableBody');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="3" style="text-align: center; padding: 20px; color: red;">
                        <div style="font-size: 18px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                        ${message}
                    </td>
                </tr>
            `;
        }

        // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
        function sortTable(column, direction) {
            const tableBody = document.getElementById('programsTableBody');
            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π (—Å—Ç—Ä–æ–∫–∞ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º)
            const rows = Array.from(tableBody.querySelectorAll('tr')).slice(1);

            if (rows.length === 0) return;

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏
            rows.sort((a, b) => {
                const aValue = a.querySelector(`td:nth-child(${getColumnIndex(column)})`).getAttribute('data-sort-value') || '';
                const bValue = b.querySelector(`td:nth-child(${getColumnIndex(column)})`).getAttribute('data-sort-value') || '';

                const sortType = getSortType(column);

                if (sortType === 'code') {
                    return compareCodes(aValue, bValue, direction);
                } else {
                    return compareValues(aValue, bValue, direction, sortType);
                }
            });

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É (—Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º)
            const firstRow = tableBody.querySelector('tr:first-child');
            tableBody.innerHTML = '';
            if (firstRow) {
                tableBody.appendChild(firstRow);
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
            rows.forEach(row => tableBody.appendChild(row));

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            updateSortIndicators(column, direction);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
            currentSort = { column, direction };
        }

        // –§—É–Ω–∫—Ü–∏—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π
        function compareValues(a, b, direction, type = 'text') {
            let valA = a.trim().toLowerCase();
            let valB = b.trim().toLowerCase();

            // –î–ª—è —á–∏—Å–ª–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
            if (type === 'number') {
                valA = parseFloat(valA) || 0;
                valB = parseFloat(valB) || 0;
            }

            // –î–ª—è –¥–∞—Ç
            if (type === 'date') {
                valA = new Date(valA).getTime();
                valB = new Date(valB).getTime();
            }

            // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º
            if (valA < valB) return direction === 'asc' ? -1 : 1;
            if (valA > valB) return direction === 'asc' ? 1 : -1;
            return 0;
        }

        // –§—É–Ω–∫—Ü–∏—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –∫–æ–¥–æ–≤ (09.02.01)
        function compareCodes(a, b, direction) {
            // –ü—Ä–∏–≤–æ–¥–∏–º –∫ –æ–±—â–µ–º—É –≤–∏–¥—É –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            const codeA = a === '-' ? '00.00.00' : a;
            const codeB = b === '-' ? '00.00.00' : b;

            // –†–∞–∑–±–∏–≤–∞–µ–º –∫–æ–¥ –Ω–∞ —á–∞—Å—Ç–∏
            const partsA = codeA.split('.').map(Number);
            const partsB = codeB.split('.').map(Number);

            // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –∫–∞–∂–¥—É—é —á–∞—Å—Ç—å
            for (let i = 0; i < 3; i++) {
                if (partsA[i] !== partsB[i]) {
                    return direction === 'asc'
                        ? partsA[i] - partsB[i]
                        : partsB[i] - partsA[i];
                }
            }

            return 0;
        }

        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω–¥–µ–∫—Å —Å—Ç–æ–ª–±—Ü–∞ –ø–æ –µ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—é
        function getColumnIndex(columnName) {
            const headers = {
                'code': 1,
                'name': 2,
                'level': 3
            };
            return headers[columnName] || 1;
        }

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –¥–ª—è —Å—Ç–æ–ª–±—Ü–∞
        function getSortType(columnName) {
            const types = {
                'code': 'code',
                'name': 'text',
                'level': 'text'
            };
            return types[columnName] || 'text';
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        function updateSortIndicators(column, direction) {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
            document.querySelectorAll('th[data-sort]').forEach(th => {
                th.classList.remove('sorted', 'sorted-asc', 'sorted-desc');
            });

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–æ–ª–±—Ü–∞
            const currentTh = document.querySelector(`th[data-sort="${column}"]`);
            if (currentTh) {
                currentTh.classList.add('sorted', `sorted-${direction}`);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫
        function handleHeaderClick(event) {
            const th = event.target.closest('th[data-sort]');
            if (!th) return;

            const column = th.getAttribute('data-sort');

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            let direction = 'asc';
            if (currentSort.column === column) {
                direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            }

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—É
            sortTable(column, direction);
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–∞–º
        function filterPrograms() {
            const searchInput = document.getElementById('searchPrograms');
            const searchTerm = searchInput.value.toLowerCase().trim();

            console.log('–ü–æ–∏—Å–∫ –ø–æ –∑–∞–ø—Ä–æ—Å—É:', searchTerm);

            if (!currentFaculty) {
                showError('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–∫—É–ª—å—Ç–µ—Ç');
                return;
            }

            if (!currentPrograms || currentPrograms.length === 0) {
                showError('–ù–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º –¥–ª—è –ø–æ–∏—Å–∫–∞');
                return;
            }

            // –ï—Å–ª–∏ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –ø—É—Å—Ç–æ–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã
            if (searchTerm === '') {
                updateProgramsTable(currentPrograms, currentFaculty, currentPrograms.length);
                return;
            }

            // –§–∏–ª—å—Ç—Ä—É–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—ã –ø–æ –ø–æ–∏—Å–∫–æ–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É
            const filtered = currentPrograms.filter(program => {
                // –ò—â–µ–º –≤ –ø–æ–ª–Ω–æ–º –Ω–∞–∑–≤–∞–Ω–∏–∏ (original_name –∏–ª–∏ name)
                const fullName = program.original_name || program.name || '';
                const level = program.level || '';
                const code = program.code || '';

                // –ü–æ–∏—Å–∫ –≤ –ø–æ–ª–Ω–æ–º –Ω–∞–∑–≤–∞–Ω–∏–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã
                const nameMatch = fullName.toLowerCase().includes(searchTerm);

                // –ü–æ–∏—Å–∫ –≤ —É—Ä–æ–≤–Ω–µ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
                const levelMatch = level.toLowerCase().includes(searchTerm);

                // –ü–æ–∏—Å–∫ –≤ –∫–æ–¥–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã
                const codeMatch = code.toLowerCase().includes(searchTerm);

                return nameMatch || levelMatch || codeMatch;
            });

            console.log(`–ù–∞–π–¥–µ–Ω–æ ${filtered.length} –ø—Ä–æ–≥—Ä–∞–º–º –ø–æ –∑–∞–ø—Ä–æ—Å—É "${searchTerm}"`);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É —Å –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
            updateProgramsTable(filtered, currentFaculty, filtered.length);
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –ø–æ–∏—Å–∫–∞
        function clearSearch() {
            const searchInput = document.getElementById('searchPrograms');
            searchInput.value = '';

            if (currentFaculty && currentPrograms.length > 0) {
                updateProgramsTable(currentPrograms, currentFaculty, currentPrograms.length);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞ –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∏
            document.querySelectorAll('th[data-sort]').forEach(th => {
                th.addEventListener('click', handleHeaderClick);
            });

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            currentSort = { column: 'code', direction: 'asc' };

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ Enter
            const searchInput = document.getElementById('searchPrograms');
            if (searchInput) {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è Enter
                searchInput.addEventListener('keyup', function(event) {
                    if (event.key === 'Enter') {
                        filterPrograms();
                    }
                });

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ (–∞–≤—Ç–æ–ø–æ–∏—Å–∫)
                searchInput.addEventListener('input', function() {
                    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
                    filterPrograms();
                });
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –æ—á–∏—Å—Ç–∫–∏ –ø–æ–∏—Å–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            const searchButton = document.querySelector('.search-box button');
            if (searchButton) {
                // –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ - –æ—á–∏—Å—Ç–∫–∞ –ø–æ–∏—Å–∫–∞
                searchButton.addEventListener('dblclick', function(event) {
                    event.preventDefault();
                    clearSearch();
                });
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
            resetTable();
        });
    </script>
</div>

	</div>
{% endblock main %}